---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { getNeighbors } from 'sailkit/packages/compass';
import ChallengeWorkspace from '../../components/ChallengeWorkspace';

export async function getStaticPaths() {
  const challenges = await getCollection('challenges');
  return challenges.map((challenge) => ({
    params: { slug: challenge.id },
    props: { challenge },
  }));
}

const { challenge } = Astro.props;
const { Content } = await render(challenge);

// Import starter code and test code as raw strings
const starterModules = import.meta.glob('/src/challenges/*/starter.ts', { query: '?raw', import: 'default', eager: true });
const testModules = import.meta.glob('/src/challenges/*/tests.ts', { query: '?raw', import: 'default', eager: true });

const starterCode = starterModules[`/src/challenges/${challenge.id}/starter.ts`] as string;
const testCode = testModules[`/src/challenges/${challenge.id}/tests.ts`] as string;

// Prev/next via compass
const courses = await getCollection('courses');
const course = courses.find((c) => c.id === challenge.data.course);
const challengeSlugs = course?.data.challenges ?? [];
const { prev, next } = getNeighbors(challengeSlugs, challenge.id);
---

<Layout title={`${challenge.data.title} â€” leetdeeper`} fullWidth>
  <div class="challenge-nav">
    {prev ? <a href={`/challenge/${prev}/`}>&larr; Previous</a> : <span />}
    <a href="/challenges/">All Challenges</a>
    {next ? <a href={`/challenge/${next}/`}>Next &rarr;</a> : <span />}
  </div>

  <!-- Server-rendered description for SEO; React component reads via DOM -->
  <template id="challenge-description"><Content /></template>

  <div class="workspace-loading" id="workspace-container">
    <div class="workspace-placeholder">Loading editor...</div>
    <ChallengeWorkspace
      client:only="react"
      slug={challenge.id}
      starterCode={starterCode}
      testCode={testCode}
    />
  </div>
</Layout>

<style>
  .challenge-nav {
    display: flex;
    justify-content: space-between;
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .challenge-nav a { color: var(--color-text-muted); text-decoration: none; }
  .challenge-nav a:hover { color: var(--color-accent); }

  /* Hide serialized props from client:only before hydration */
  .workspace-loading astro-island > code { display: none; }
  .workspace-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: calc(100vh - 110px);
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }
  /* Hide placeholder once React mounts */
  .workspace-loading:has([data-testid="editor"]) .workspace-placeholder { display: none; }
</style>
