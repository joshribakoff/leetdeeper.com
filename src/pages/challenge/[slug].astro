---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { getNeighbors } from 'sailkit/packages/compass';
import ChallengeWorkspace from '../../components/ChallengeWorkspace';
import { validateManifest, type SolutionWithCode } from '../../lib/solutions-schema';

export async function getStaticPaths() {
  const challenges = await getCollection('challenges');
  return challenges.map((challenge) => ({
    params: { slug: challenge.id },
    props: { challenge },
  }));
}

const { challenge } = Astro.props;
const { Content } = await render(challenge);

// Import starter code and test code as raw strings
const starterModules = import.meta.glob('/src/challenges/*/starter.ts', { query: '?raw', import: 'default', eager: true });
const testModules = import.meta.glob('/src/challenges/*/tests.ts', { query: '?raw', import: 'default', eager: true });

const starterCode = starterModules[`/src/challenges/${challenge.id}/starter.ts`] as string;
const testCode = testModules[`/src/challenges/${challenge.id}/tests.ts`] as string;

// Load solutions (optional per challenge)
const solutionManifests = import.meta.glob('/src/challenges/*/solutions.json', { eager: true });
const solutionCodeModules = import.meta.glob('/src/challenges/*/solutions/*.ts', { query: '?raw', import: 'default', eager: true });

let solutions: SolutionWithCode[] = [];
const manifestPath = `/src/challenges/${challenge.id}/solutions.json`;
if (solutionManifests[manifestPath]) {
  const manifest = validateManifest((solutionManifests[manifestPath] as any).default, challenge.id);
  solutions = manifest.map((meta) => {
    const codePath = `/src/challenges/${challenge.id}/solutions/${meta.key}.ts`;
    const code = solutionCodeModules[codePath] as string;
    if (!code) throw new Error(`Missing solution file: ${codePath}`);
    return { ...meta, code };
  });
}

// Prev/next via compass
const courses = await getCollection('courses');
const course = courses.find((c) => c.id === challenge.data.course);
const challengeSlugs = course?.data.challenges ?? [];
const { prev, next } = getNeighbors(challengeSlugs, challenge.id);
---

<Layout title={`${challenge.data.title} â€” leetdeeper`} fullWidth>
  <div class="challenge-nav">
    {prev
      ? <a href={`/challenge/${prev}/`}>&larr; Previous</a>
      : <span class="disabled">&larr; Previous</span>}
    {next
      ? <a href={`/challenge/${next}/`}>Next &rarr;</a>
      : <span class="disabled">Next &rarr;</span>}
  </div>

  <!-- Server-rendered description for SEO; React component reads via DOM -->
  <template id="challenge-description"><Content /></template>

  <div class="workspace-loading" id="workspace-container">
    <div class="workspace-placeholder">Loading editor...</div>
    <ChallengeWorkspace
      client:only="react"
      slug={challenge.id}
      starterCode={starterCode}
      testCode={testCode}
      solutions={solutions}
    />
  </div>
</Layout>

<style>
  .challenge-nav {
    display: flex;
    justify-content: space-between;
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .challenge-nav a { color: var(--color-text-muted); text-decoration: none; }
  .challenge-nav a:hover { color: var(--color-accent); }
  .challenge-nav .disabled { opacity: 0.3; }

  /* Hide serialized props from client:only before hydration */
  .workspace-loading astro-island > code { display: none; }
  .workspace-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: calc(100vh - 110px);
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }
  /* Hide placeholder once React mounts */
  .workspace-loading:has([data-testid="editor"]) .workspace-placeholder { display: none; }
</style>
