---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const courses = await getCollection('courses');
const challenges = await getCollection('challenges');

// Build a lookup: slug → challenge
const challengeMap = new Map(challenges.map((c) => [c.id, c]));
---

<Layout title="Challenges — leetdeeper">
  {courses.map((course) => (
    <section class="course-section">
      <h2>{course.data.title}</h2>
      <ol class="challenge-list">
        {course.data.challenges.map((slug) => {
          const challenge = challengeMap.get(slug);
          if (!challenge) return null;
          return (
            <li>
              <a href={`/challenge/${slug}/`}>
                <span class="challenge-title">{challenge.data.title}</span>
                <span class={`difficulty ${challenge.data.difficulty}`}>{challenge.data.difficulty}</span>
              </a>
            </li>
          );
        })}
      </ol>
    </section>
  ))}

  <script is:inline>
    // Mark completed challenges on the index page
    const completed = JSON.parse(localStorage.getItem('leetdeeper:completed') ?? '[]');
    document.querySelectorAll('.challenge-list a').forEach((a) => {
      const slug = a.getAttribute('href')?.replace('/challenge/', '').replace(/\/$/, '');
      if (slug && completed.includes(slug)) {
        a.classList.add('completed');
      }
    });
  </script>
</Layout>

<style>
  .course-section {
    margin-bottom: var(--space-8);
  }

  .course-section h2 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-4);
  }

  .challenge-list {
    list-style: none;
    padding: 0;
    counter-reset: challenge;
  }

  .challenge-list li {
    counter-increment: challenge;
  }

  .challenge-list a {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) 0;
    border-bottom: 1px solid var(--color-border);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .challenge-list li:first-child a {
    border-top: 1px solid var(--color-border);
  }

  .challenge-list a::before {
    content: counter(challenge);
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    min-width: 2ch;
    text-align: right;
  }

  .challenge-list a:hover .challenge-title { color: var(--color-accent); }

  .challenge-list a.completed::after {
    content: "\2713";
    color: var(--color-success);
    margin-left: auto;
    font-weight: bold;
  }

  .challenge-title {
    flex: 1;
    color: var(--color-text);
    transition: color var(--transition-fast);
  }

  .difficulty {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: lowercase;
  }

  .difficulty.easy { color: var(--color-success); }
  .difficulty.medium { color: var(--color-warning); }
  .difficulty.hard { color: var(--color-error); }
</style>
